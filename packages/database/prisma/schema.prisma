// MAPATUR - Sistema Guia de Turismo de Corumbá (MS)
// Prisma Schema Definition

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// PRODUCTION TABLES - Unidades Turísticas
// ============================================================================

model PROD_UnidadeTuristica {
  id                     Int                                  @id @default(autoincrement())

  // Campos básicos (mantidos)
  nome                   String                               @db.VarChar(255)
  endereco               String?                              @db.VarChar(500)
  id_bairro              Int?
  latitude               Decimal                              @db.Decimal(10, 8) // NOT NULL - obrigatório para mapa
  longitude              Decimal                              @db.Decimal(11, 8) // NOT NULL - obrigatório para mapa
  telefone               String?                              @db.VarChar(100)
  whatsapp               String?                              @db.VarChar(100)
  email                  String?                              @db.VarChar(255)
  horario_funcionamento  String?                              @db.Text
  imagem_url             String?                              @db.VarChar(500)
  icone_url              String?                              @db.VarChar(500)
  ativo                  Boolean                              @default(true)
  created_at             DateTime                             @default(now())
  updated_at             DateTime                             @updatedAt

  // NOVOS CAMPOS TURÍSTICOS
  nome_fantasia          String?                              @db.VarChar(255)  // Nome comercial
  razao_social           String?                              @db.VarChar(255)  // Nome empresarial
  cnpj                   String?                              @db.VarChar(20)   // Cadastro
  setor                  String?                              @db.VarChar(100)  // Ex: "AGÊNCIA VIAGENS"
  descricao_servicos     String?                              @db.Text          // Campo "Serviço" da planilha
  data_cadastro          DateTime?                                              // INICIO VIG
  data_vencimento        DateTime?                                              // VENCIMENTO

  // Relações
  bairro                 PROD_Bairro?                         @relation(fields: [id_bairro], references: [id], onDelete: SetNull)
  redes_sociais          PROD_UnidadeTuristica_RedeSocial[]
  categorias             Junction_UnidadeTuristica_Categoria[]

  @@index([ativo])
  @@index([latitude, longitude])
  @@index([id_bairro])
  @@index([setor])
  @@map("prod_unidade_turistica")
}

model PROD_UnidadeTuristica_RedeSocial {
  id          Int                      @id @default(autoincrement())
  id_unidade  Int
  nome_rede   String                   @db.VarChar(50)
  url_perfil  String                   @db.VarChar(500)
  created_at  DateTime                 @default(now())
  updated_at  DateTime                 @updatedAt

  unidade     PROD_UnidadeTuristica    @relation(fields: [id_unidade], references: [id], onDelete: Cascade)

  @@index([id_unidade])
  @@map("prod_unidade_turistica_redesocial")
}

// ============================================================================
// CATEGORIAS TURÍSTICAS
// ============================================================================

model PROD_Categoria {
  id            Int                                    @id @default(autoincrement())
  nome          String                                 @db.VarChar(100)         // "Onde Passear", "Organize sua Viagem" (1º nível)
  subcategoria  String?                                @db.VarChar(100)         // "Circuitos Culturais", "Afroturismo", etc. (2º nível)
  segmento      String?                                @db.VarChar(100)         // Segmento específico (3º nível)
  ativo         Boolean                                @default(true)
  ordem         Int                                    @default(0)
  created_at    DateTime                               @default(now())
  updated_at    DateTime                               @updatedAt

  // Relações
  unidades      Junction_UnidadeTuristica_Categoria[]

  @@unique([nome, subcategoria, segmento])  // Cada combinação categoria+subcategoria+segmento é única
  @@index([nome])
  @@index([subcategoria])
  @@index([ativo])
  @@map("prod_categoria")
}

// ============================================================================
// JUNCTION TABLES - Relações N:N
// ============================================================================

model Junction_UnidadeTuristica_Categoria {
  id_unidade     Int
  id_categoria   Int
  created_at     DateTime               @default(now())

  unidade        PROD_UnidadeTuristica  @relation(fields: [id_unidade], references: [id], onDelete: Cascade)
  categoria      PROD_Categoria         @relation(fields: [id_categoria], references: [id], onDelete: Cascade)

  @@id([id_unidade, id_categoria])
  @@index([id_unidade])
  @@index([id_categoria])
  @@map("junction_unidade_categoria")
}

// ============================================================================
// USER MANAGEMENT - Sistema de usuários e RBAC
// ============================================================================

model User {
  id                Int                              @id @default(autoincrement())
  username          String                           @unique @db.VarChar(50)
  email             String                           @unique @db.VarChar(255)
  password_hash     String                           @db.VarChar(255)
  role              UserRole                         @default(admin)
  ativo             Boolean                          @default(true)
  created_at        DateTime                         @default(now())
  updated_at        DateTime                         @updatedAt
  last_login        DateTime?

  // Relações
  audit_logs        AUDIT_LOG[]

  @@index([username])
  @@index([email])
  @@index([role])
  @@map("user")
}

enum UserRole {
  admin
  superadmin
}

// ============================================================================
// AUDIT SYSTEM - Sistema de auditoria imutável
// ============================================================================

model AUDIT_LOG {
  id                Int                              @id @default(autoincrement())
  tabela            String                           @db.VarChar(100)
  operacao          OperacaoAudit
  registro_id       Int
  valor_antigo      String?                          @db.Text // JSON
  valor_novo        String?                          @db.Text // JSON
  user_id           Int?
  correlation_id    String?                          @db.VarChar(100)
  timestamp         DateTime                         @default(now())

  // Relações
  user              User?                            @relation(fields: [user_id], references: [id], onDelete: SetNull)

  @@index([tabela])
  @@index([operacao])
  @@index([user_id])
  @@index([timestamp])
  @@index([correlation_id])
  @@map("audit_log")
}

enum OperacaoAudit {
  INSERT
  UPDATE
  DELETE
}

// ============================================================================
// BAIRROS - Gerenciamento de bairros de Corumbá
// ============================================================================

model PROD_Bairro {
  id         Int                      @id @default(autoincrement())
  nome       String                   @unique @db.VarChar(100)
  ativo      Boolean                  @default(true)
  created_at DateTime                 @default(now())
  updated_at DateTime                 @updatedAt

  // Relações
  unidades   PROD_UnidadeTuristica[]

  @@index([nome])
  @@index([ativo])
  @@map("prod_bairro")
}

// ============================================================================
// ÍCONES - Gerenciamento de ícones para tipos de unidades turísticas
// ============================================================================

model PROD_Icone {
  id         Int      @id @default(autoincrement())
  nome       String   @unique @db.VarChar(100) // Ex: Hotel, Restaurante, Agência
  url        String   @db.VarChar(500)
  ativo      Boolean  @default(true)
  ordem      Int      @default(0)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([ativo])
  @@index([ordem])
  @@map("prod_icone")
}
