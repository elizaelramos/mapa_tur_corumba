// MAPATUR - Sistema Guia de Turismo de Corumbá (MS)
// Prisma Schema Definition

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// PRODUCTION TABLES - Unidades Turísticas
// ============================================================================

model PROD_UnidadeTuristica {
  id                     Int                                  @id @default(autoincrement())

  // Campos básicos (mantidos)
  nome                   String                               @db.VarChar(255)
  endereco               String?                              @db.VarChar(500)
  id_bairro              Int?
  latitude               Decimal                              @db.Decimal(10, 8) // NOT NULL - obrigatório para mapa
  longitude              Decimal                              @db.Decimal(11, 8) // NOT NULL - obrigatório para mapa
  telefone               String?                              @db.VarChar(100)
  whatsapp               String?                              @db.VarChar(100)
  email                  String?                              @db.VarChar(255)
  horario_funcionamento  String?                              @db.Text
  imagem_url             String?                              @db.VarChar(500)
  icone_url              String?                              @db.VarChar(500)
  // Gestão escolar
  diretor_responsavel    String?                              @db.VarChar(255)
  diretor_adjunto        String?                              @db.VarChar(255)
  ativo                  Boolean                              @default(true)
  created_at             DateTime                             @default(now())
  updated_at             DateTime                             @updatedAt

  // NOVOS CAMPOS TURÍSTICOS
  nome_fantasia          String?                              @db.VarChar(255)  // Nome comercial
  razao_social           String?                              @db.VarChar(255)  // Nome empresarial
  cnpj                   String?                              @db.VarChar(20)   // Cadastro
  setor                  String?                              @db.VarChar(100)  // Ex: "AGÊNCIA VIAGENS"
  descricao_servicos     String?                              @db.Text          // Campo "Serviço" da planilha
  data_cadastro          DateTime?                                              // INICIO VIG
  data_vencimento        DateTime?                                              // VENCIMENTO

  // Relações
  bairro                 PROD_Bairro?                         @relation(fields: [id_bairro], references: [id], onDelete: SetNull)
  redes_sociais          PROD_UnidadeTuristica_RedeSocial[]
  categorias             Junction_UnidadeTuristica_Categoria[]

  @@index([ativo])
  @@index([latitude, longitude])
  @@index([id_bairro])
  @@index([setor])
  @@map("prod_unidade_turistica")
}

model PROD_UnidadeTuristica_RedeSocial {
  id          Int                      @id @default(autoincrement())
  id_unidade  Int
  nome_rede   String                   @db.VarChar(50)
  url_perfil  String                   @db.VarChar(500)
  created_at  DateTime                 @default(now())
  updated_at  DateTime                 @updatedAt

  unidade     PROD_UnidadeTuristica    @relation(fields: [id_unidade], references: [id], onDelete: Cascade)

  @@index([id_unidade])
  @@map("prod_unidade_turistica_redesocial")
}

// ============================================================================
// CATEGORIAS TURÍSTICAS
// ============================================================================

model PROD_Categoria {
  id            Int                                    @id @default(autoincrement())
  nome          String                                 @db.VarChar(100)         // "Onde Passear", "Organize sua Viagem" (1º nível)
  subcategoria  String?                                @db.VarChar(100)         // "Circuitos Culturais", "Afroturismo", etc. (2º nível)
  segmento      String?                                @db.VarChar(100)         // Segmento específico (3º nível)
  ativo         Boolean                                @default(true)
  ordem         Int                                    @default(0)
  created_at    DateTime                               @default(now())
  updated_at    DateTime                               @updatedAt

  // Relações
  unidades      Junction_UnidadeTuristica_Categoria[]

  @@unique([nome, subcategoria, segmento])  // Cada combinação categoria+subcategoria+segmento é única
  @@index([nome])
  @@index([subcategoria])
  @@index([ativo])
  @@map("prod_categoria")
}

// ============================================================================
// JUNCTION TABLES - Relações N:N
// ============================================================================

model Junction_UnidadeTuristica_Categoria {
  id_unidade     Int
  id_categoria   Int
  created_at     DateTime               @default(now())

  unidade        PROD_UnidadeTuristica  @relation(fields: [id_unidade], references: [id], onDelete: Cascade)
  categoria      PROD_Categoria         @relation(fields: [id_categoria], references: [id], onDelete: Cascade)

  @@id([id_unidade, id_categoria])
  @@index([id_unidade])
  @@index([id_categoria])
  @@map("junction_unidade_categoria")
}

// ============================================================================
// USER MANAGEMENT - Sistema de usuários e RBAC
// ============================================================================

model User {
  id                Int                              @id @default(autoincrement())
  username          String                           @unique @db.VarChar(50)
  email             String                           @unique @db.VarChar(255)
  password_hash     String                           @db.VarChar(255)
  role              UserRole                         @default(admin)
  ativo             Boolean                          @default(true)
  created_at        DateTime                         @default(now())
  updated_at        DateTime                         @updatedAt
  last_login        DateTime?

  // Relações
  audit_logs        AUDIT_LOG[]

  @@index([username])
  @@index([email])
  @@index([role])
  @@map("user")
}

enum UserRole {
  admin
  superadmin
}

// ============================================================================
// AUDIT SYSTEM - Sistema de auditoria imutável
// ============================================================================

model AUDIT_LOG {
  id                Int                              @id @default(autoincrement())
  tabela            String                           @db.VarChar(100)
  operacao          OperacaoAudit
  registro_id       Int
  valor_antigo      String?                          @db.Text // JSON
  valor_novo        String?                          @db.Text // JSON
  user_id           Int?
  correlation_id    String?                          @db.VarChar(100)
  timestamp         DateTime                         @default(now())

  // Relações
  user              User?                            @relation(fields: [user_id], references: [id], onDelete: SetNull)

  @@index([tabela])
  @@index([operacao])
  @@index([user_id])
  @@index([timestamp])
  @@index([correlation_id])
  @@map("audit_log")
}

enum OperacaoAudit {
  INSERT
  UPDATE
  DELETE
}

// ============================================================================
// BAIRROS - Gerenciamento de bairros de Corumbá
// ============================================================================

model PROD_Bairro {
  id         Int                      @id @default(autoincrement())
  nome       String                   @unique @db.VarChar(100)
  ativo      Boolean                  @default(true)
  created_at DateTime                 @default(now())
  updated_at DateTime                 @updatedAt

  // Relações
  unidades   PROD_UnidadeTuristica[]

  @@index([nome])
  @@index([ativo])
  @@map("prod_bairro")
}

// ============================================================================
// ÍCONES - Gerenciamento de ícones para tipos de unidades turísticas
// ============================================================================

model PROD_Icone {
  id         Int      @id @default(autoincrement())
  nome       String   @unique @db.VarChar(100) // Ex: Hotel, Restaurante, Agência
  url        String   @db.VarChar(500)
  ativo      Boolean  @default(true)
  ordem      Int      @default(0)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([ativo])
  @@index([ordem])
  @@map("prod_icone")
}

// ============================================================================
// GUIAS TURÍSTICOS - Profissionais de turismo sem localização no mapa
// ============================================================================

model PROD_GuiaTuristico {
  id         Int      @id @default(autoincrement())
  nome       String   @db.VarChar(255)
  whatsapp   String   @db.VarChar(100)  // Telefone/WhatsApp principal
  idiomas    String   @db.VarChar(255)  // Ex: "Português, Espanhol, Inglês"
  foto_url   String?  @db.VarChar(500)  // Foto do guia (opcional)
  descricao  String?  @db.Text          // Descrição/apresentação do guia
  ativo      Boolean  @default(true)
  ordem      Int      @default(0)       // Para ordenação personalizada
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([ativo])
  @@index([ordem])
  @@map("prod_guia_turistico")
}

// ============================================================================
// ANALYTICS - Sistema de Analytics Proprietário
// ============================================================================

// Tabela principal de eventos de analytics
model ANALYTICS_Event {
  id                 BigInt          @id @default(autoincrement())

  // Identificação de sessão (anônima)
  session_id         String          @db.VarChar(100)        // UUID gerado no frontend

  // Tipo de evento
  event_type         EventType

  // Dados do evento (JSON flexível para diferentes tipos)
  event_data         String          @db.Text                // JSON com dados específicos do evento

  // Contexto da requisição
  user_agent         String?         @db.VarChar(500)
  ip_hash            String?         @db.VarChar(64)         // IP anonimizado (SHA256)
  referrer           String?         @db.VarChar(500)

  // Timestamp
  created_at         DateTime        @default(now())

  @@index([event_type])
  @@index([session_id])
  @@index([created_at])
  @@index([event_type, created_at])
  @@map("analytics_event")
}

enum EventType {
  PAGE_VIEW           // Visualização de página
  SEARCH              // Busca realizada
  UNIT_VIEW           // Visualização de unidade
  MAP_CLICK           // Clique no mapa
  CONTACT_CLICK       // Clique em contato (WhatsApp, Email, Telefone, Como Chegar)
  SOCIAL_CLICK        // Clique em rede social
  FILTER_APPLIED      // Filtro aplicado
  ERROR               // Erro de frontend
}

// Tabela de sessões agregadas (para performance em queries)
model ANALYTICS_Session {
  id                 BigInt          @id @default(autoincrement())
  session_id         String          @unique @db.VarChar(100)

  // Contadores agregados
  page_views         Int             @default(0)
  searches           Int             @default(0)
  unit_views         Int             @default(0)
  contacts           Int             @default(0)

  // Primeira e última atividade
  first_seen         DateTime
  last_seen          DateTime

  // Duração calculada (segundos)
  duration_seconds   Int?

  // Dados do navegador
  user_agent         String?         @db.VarChar(500)
  ip_hash            String?         @db.VarChar(64)

  @@index([first_seen])
  @@index([last_seen])
  @@map("analytics_session")
}

// Tabela de popularidade de unidades (agregação diária)
model ANALYTICS_UnitStats {
  id                 BigInt          @id @default(autoincrement())

  unit_id            Int                                     // ID da unidade
  date               DateTime        @db.Date                // Data da estatística

  // Métricas
  views              Int             @default(0)             // Visualizações
  map_clicks         Int             @default(0)             // Cliques no mapa
  contacts_whatsapp  Int             @default(0)
  contacts_phone     Int             @default(0)
  contacts_email     Int             @default(0)
  contacts_directions Int            @default(0)             // Como chegar
  social_clicks      Int             @default(0)

  // Taxa de conversão calculada
  conversion_rate    Decimal?        @db.Decimal(5, 2)       // % (views → contacts)

  created_at         DateTime        @default(now())
  updated_at         DateTime        @updatedAt

  @@unique([unit_id, date])
  @@index([date])
  @@index([unit_id])
  @@index([views])
  @@index([conversion_rate])
  @@map("analytics_unit_stats")
}

// Tabela de buscas populares (agregação)
model ANALYTICS_SearchStats {
  id                 BigInt          @id @default(autoincrement())

  search_term        String          @db.VarChar(255)
  search_type        String          @db.VarChar(50)         // 'texto_livre', 'unidade', 'categoria', etc.

  count              Int             @default(1)
  last_searched      DateTime        @default(now())

  @@unique([search_term, search_type])
  @@index([count])
  @@index([last_searched])
  @@map("analytics_search_stats")
}

// Tabela de performance técnica
model ANALYTICS_Performance {
  id                 BigInt          @id @default(autoincrement())

  metric_type        PerformanceMetric
  metric_value       Decimal         @db.Decimal(10, 2)      // Valor numérico
  metric_unit        String          @db.VarChar(20)         // 'ms', 'bytes', 'count'

  // Contexto
  page               String?         @db.VarChar(255)
  session_id         String?         @db.VarChar(100)

  created_at         DateTime        @default(now())

  @@index([metric_type])
  @@index([created_at])
  @@map("analytics_performance")
}

enum PerformanceMetric {
  PAGE_LOAD_TIME
  API_RESPONSE_TIME
  ERROR_COUNT
  NETWORK_LATENCY
}
